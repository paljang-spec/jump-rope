import streamlit as st
import sqlite3
import pandas as pd
from datetime import datetime
from contextlib import contextmanager
import io

# Page Configuration
st.set_page_config(page_title="ê²½ì¡°ì‚¬ ê¸ˆì•¡ ê´€ë¦¬", page_icon="ğŸ’°", layout="wide")

# --- Database Management ---
@contextmanager
def db_cursor():
    """Context manager for database connection and cursor."""
    conn = None
    try:
        conn = sqlite3.connect("donation_data.db")
        cursor = conn.cursor()
        yield cursor
        conn.commit()
    except sqlite3.Error as e:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {e}")
        if conn:
            conn.rollback()
        raise
    finally:
        if conn:
            conn.close()

def init_database():
    """Initialize the database table if it doesn't exist."""
    try:
        with db_cursor() as cursor:
            cursor.execute('''CREATE TABLE IF NOT EXISTS donations (
                                id INTEGER PRIMARY KEY,
                                name TEXT NOT NULL,
                                amount REAL NOT NULL,
                                date TEXT NOT NULL,
                                category TEXT
                            )''')
    except sqlite3.Error as e:
        st.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
        st.stop()

def format_currency(amount):
    """Format amount as currency."""
    if amount is None:
        return "0"
    return f"{float(amount):,.0f}"

# --- Main Application ---
def main():
    st.title("ğŸ’° ê²½ì¡°ì‚¬ ê¸ˆì•¡ ê´€ë¦¬ í”„ë¡œê·¸ë¨")

    # Initialize database
    init_database()

    # --- Sidebar for Inputs ---
    with st.sidebar:
        st.header("ì •ë³´ ì…ë ¥/ìˆ˜ì •")

        # Check if we are in edit mode
        if 'edit_id' in st.session_state and st.session_state.edit_id:
            st.info(f"ID: {st.session_state.edit_id} í•­ëª©ì„ ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤.")

        name = st.text_input("ì´ë¦„", value=st.session_state.get('name', ''))
        category = st.selectbox("ì¹´í…Œê³ ë¦¬", ["ê²°í˜¼", "ì¥ë¡€", "ìƒì¼", "ê¸°íƒ€"], index=["ê²°í˜¼", "ì¥ë¡€", "ìƒì¼", "ê¸°íƒ€"].index(st.session_state.get('category', 'ê²°í˜¼')))
        amount = st.number_input("ê¸ˆì•¡", min_value=0, step=10000, value=st.session_state.get('amount', 0))

        # Quick Amount Buttons
        st.write("**ê°„í¸ ì…ë ¥:**")
        fav_amounts = [10000, 30000, 50000, 100000, 300000, 500000]
        cols = st.columns(3)
        for i, fav_amount in enumerate(fav_amounts):
            if cols[i % 3].button(f"{fav_amount // 10000}ë§Œ" if fav_amount >= 10000 else f"{fav_amount}ì›"):
                amount = fav_amount


        col1, col2, col3 = st.columns([1,1,1])

        # Add/Update Button
        if 'edit_id' in st.session_state and st.session_state.edit_id:
            if col1.button("ìˆ˜ì • ì™„ë£Œ", use_container_width=True, type="primary"):
                update_donation(st.session_state.edit_id, name, amount, category)
            if col2.button("ì·¨ì†Œ", use_container_width=True):
                clear_edit_state()
        else:
            if col1.button("ì¶”ê°€í•˜ê¸°", use_container_width=True, type="primary"):
                add_donation(name, amount, category)

    # --- Main Content Area ---
    st.header("ê²½ì¡°ì‚¬ ëª©ë¡")

    # Search and Sort
    col1, col2 = st.columns([3, 1])
    with col1:
        search_term = st.text_input("ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰", placeholder="ê²€ìƒ‰í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”...")
    with col2:
        sort_by = st.radio("ì •ë ¬ ê¸°ì¤€", ["ë‚ ì§œ", "ì´ë¦„", "ê¸ˆì•¡"], horizontal=True)

    # Load and display data
    df = load_donations(search_term, sort_by)
    st.dataframe(df.style.apply(lambda x: ['background-color: #e0f7fa' if x.amount >= 100000 else '' for i in x], axis=1), use_container_width=True)


    # --- Totals and Actions ---
    total_amount = df['amount'].sum()
    st.metric(label="ì´ ê¸ˆì•¡", value=f"{format_currency(total_amount)} ì›")

    # Edit and Delete buttons
    selected_id = st.selectbox("ìˆ˜ì • ë˜ëŠ” ì‚­ì œí•  í•­ëª©ì˜ IDë¥¼ ì„ íƒí•˜ì„¸ìš”.", options=[""] + list(df['id']))
    if selected_id:
        col1, col2 = st.columns(2)
        if col1.button("ì„ íƒí•œ í•­ëª© ìˆ˜ì •í•˜ê¸°"):
            start_edit(selected_id)
        if col2.button("ì„ íƒí•œ í•­ëª© ì‚­ì œí•˜ê¸°", type="secondary"):
            delete_donation(selected_id)

    # --- Data Export ---
    st.markdown("---")
    st.header("ë°ì´í„° ë‚´ë³´ë‚´ê¸°")
    export_col1, export_col2 = st.columns(2)
    csv_data = df.to_csv(index=False, encoding='utf-8-sig')
    txt_data = df.to_string(index=False)

    export_col1.download_button(
        label="CSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ",
        data=csv_data,
        file_name='donations.csv',
        mime='text/csv',
    )
    export_col2.download_button(
        label="í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ",
        data=txt_data,
        file_name='donations.txt',
        mime='text/plain',
    )


def add_donation(name, amount, category):
    if not name or amount <= 0:
        st.warning("ì´ë¦„ê³¼ 0ë³´ë‹¤ í° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return
    try:
        date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        with db_cursor() as cursor:
            cursor.execute("INSERT INTO donations (name, amount, date, category) VALUES (?, ?, ?, ?)",
                         (name, amount, date, category))
        st.success(f"'{name}'ë‹˜ì˜ ì •ë³´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")
    except sqlite3.Error as e:
        st.error(f"ì¶”ê°€ ì‹¤íŒ¨: {e}")

def load_donations(search_term="", sort_by="ë‚ ì§œ"):
    sort_map = {"ë‚ ì§œ": "date", "ì´ë¦„": "name", "ê¸ˆì•¡": "amount"}
    sort_column = sort_map.get(sort_by, "date")
    try:
        with db_cursor() as cursor:
            query = f"SELECT id, name, amount, date, category FROM donations WHERE name LIKE ? ORDER BY {sort_column} DESC"
            cursor.execute(query, (f"%{search_term}%",))
            rows = cursor.fetchall()
            df = pd.DataFrame(rows, columns=['id', 'name', 'amount', 'date', 'category'])
            return df
    except sqlite3.Error as e:
        st.error(f"ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}")
        return pd.DataFrame()

def delete_donation(item_id):
    try:
        with db_cursor() as cursor:
            cursor.execute("DELETE FROM donations WHERE id=?", (item_id,))
        st.success(f"ID {item_id} í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
        st.experimental_rerun()
    except sqlite3.Error as e:
        st.error(f"ì‚­ì œ ì‹¤íŒ¨: {e}")

def start_edit(item_id):
    try:
        with db_cursor() as cursor:
            cursor.execute("SELECT name, amount, category FROM donations WHERE id=?", (item_id,))
            record = cursor.fetchone()
        if record:
            st.session_state.edit_id = item_id
            st.session_state.name = record[0]
            st.session_state.amount = int(record[1])
            st.session_state.category = record[2]
            st.experimental_rerun()
    except sqlite3.Error as e:
        st.error(f"ìˆ˜ì •í•  ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: {e}")

def update_donation(item_id, name, amount, category):
    if not name or amount <= 0:
        st.warning("ì´ë¦„ê³¼ 0ë³´ë‹¤ í° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        return
    try:
        date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        with db_cursor() as cursor:
            cursor.execute("UPDATE donations SET name=?, amount=?, category=?, date=? WHERE id=?",
                         (name, amount, category, date, item_id))
        st.success(f"ID {item_id} í•­ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
        clear_edit_state()
    except sqlite3.Error as e:
        st.error(f"ìˆ˜ì • ì‹¤íŒ¨: {e}")

def clear_edit_state():
    """Clears the editing state from the session."""
    st.session_state.pop('edit_id', None)
    st.session_state.pop('name', None)
    st.session_state.pop('amount', None)
    st.session_state.pop('category', None)
    st.experimental_rerun()


if __name__ == "__main__":
    main()
